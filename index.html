
<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Grimório das Tarefas</title>
<style>
  :root{
    --lilac-1:#3b1670;
    --lilac-2:#7d4ef0;
    --bg-dark-1:#2a0d3b;
    --bg-dark-2:#1b0620;
    --bg-light-1:#f5eefb;
    --bg-light-2:#efe1fb;
    --muted-light:#efe6ff;
    --muted-dark:#43264a;
    --accent:#b08dff;
    --danger:#ff6b6b;
    --paper-shadow: rgba(0,0,0,0.45);
    --avatar-base:#b98bff;
    --paper:#f4e2b8;
  }
  html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial;background:linear-gradient(180deg,var(--bg-dark-1),var(--bg-dark-2));color:var(--muted-light);-webkit-font-smoothing:antialiased}
  body[data-theme="light"]{background:linear-gradient(180deg,var(--bg-light-1),var(--bg-light-2));color:var(--muted-dark)}
  .app{max-width:1100px;margin:0 auto;padding:16px;display:flex;flex-direction:column;min-height:100vh;gap:12px}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
  h1{margin:0;font-size:20px}
  .subtitle{font-size:12px;opacity:0.9}
  .top-controls{display:flex;gap:8px;align-items:center}
  button{background:var(--accent);border:none;padding:8px 10px;border-radius:8px;color:#120017;font-weight:700;cursor:pointer}
  .toggle{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:6px 8px;border-radius:8px;color:inherit;cursor:pointer}
  main{display:flex;gap:12px;align-items:flex-start;flex-wrap:wrap}
  .left{flex:0 0 320px;padding:12px;border-radius:12px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03)}
  .center{flex:1;min-width:340px}
  .right{flex:0 0 320px}
  .avatar-box{width:300px;height:200px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.05));display:flex;align-items:center;justify-content:center;position:relative;box-shadow:inset 0 6px 30px rgba(0,0,0,0.45)}
  .avatar-svg{width:160px;height:160px}
  .lvl{font-weight:800;margin-top:8px}
  .xpbar{height:14px;background:rgba(255,255,255,0.06);border-radius:12px;overflow:hidden;margin-top:8px}
  .xpfill{height:100%;background:linear-gradient(90deg,var(--lilac-1),var(--lilac-2));width:0%;transition:width 600ms}
  .inventory{margin-top:10px;display:flex;flex-direction:column;gap:8px}
  .slot-row{display:flex;gap:8px;flex-wrap:wrap}
  .slot{width:64px;height:64;border-radius:8px;background:rgba(255,255,255,0.02);display:flex;align-items:center;justify-content:center;border:1px solid rgba(255,255,255,0.04);cursor:pointer;position:relative}
  .slot.empty{opacity:0.35}
  .slot .label{position:absolute;bottom:-16px;left:50%;transform:translateX(-50%);font-size:11px}
  .tasks-panel{padding:12px;border-radius:12px;box-shadow:0 10px 40px rgba(0,0,0,0.4);background:transparent}
  .parchment{margin-top:8px;padding:12px;border-radius:10px;position:relative;min-height:240px;overflow:auto}
  body[data-theme="dark"] .parchment{background:linear-gradient(180deg, rgba(60,34,86,0.92), rgba(45,22,60,0.92));border:2px solid rgba(255,255,255,0.04);color:var(--muted-light)}
  body[data-theme="light"] .parchment{background:linear-gradient(180deg, rgba(250,244,255,0.98), rgba(245,238,255,0.98));border:2px solid rgba(140,60,170,0.12);color:var(--muted-dark)}
  .add-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:10px}
  .add-row input[type="text"], .add-row select, .add-row input[type="datetime-local"]{padding:8px;border-radius:6px;border:1px solid rgba(0,0,0,0.06);background:transparent;color:inherit}
  .task-item{display:flex;gap:10px;align-items:center;padding:8px;border-radius:8px;margin-bottom:8px;background:rgba(255,255,255,0.02)}
  .task-item .meta{font-size:12px;color:inherit;opacity:0.9;margin-top:4px}
  .task-actions{display:flex;gap:6px}
  .task-actions button{padding:6px 8px;border-radius:6px;border:none;background:linear-gradient(90deg,#7f5cf6,#b08dff);color:#120017;font-weight:800;cursor:pointer}
  .task-actions .remove{background:linear-gradient(90deg,#444,#222);color:#fff}
  .monster-area{padding:12px;border-radius:10px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03)}
  .logs{max-height:220px;overflow:auto;font-size:13px;color:var(--muted-light)}
  .small{font-size:13px}
  .shake{animation:shake 0.6s ease}
  @keyframes shake{0%{transform:translateX(0)}25%{transform:translateX(-6px)}50%{transform:translateX(6px)}75%{transform:translateX(-4px)}100%{transform:translateX(0)}}
  .fallen{opacity:0.28;transform:translateY(6px);transition:opacity 0.2s,transform 0.2s}
  footer{margin-top:12px;color:var(--muted-light);font-size:13px;text-align:center;padding:8px}
  @media(max-width:900px){main{flex-direction:column}.left,.right{flex:1}.avatar-box{width:220px;height:160px}}
  /* confirmation modal */
  .modal{position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,0.45);display:flex;align-items:center;justify-content:center;z-index:999}
  .modal-box{background:var(--bg-light-1);padding:18px;border-radius:10px;min-width:280px}
  body[data-theme="dark"] .modal-box{background:#1d0b22;color:var(--muted-light)}
  .hidden{display:none}
</style>
</head>
<body data-theme="dark">
  <div class="app" role="application">
    <header>
      <div>
        <h1>Grimório das Tarefas</h1>
        <div class="subtitle">Complete tarefas, equipe itens e suba de nível.</div>
      </div>
      <div class="top-controls">
        <button id="btnAddSample" class="toggle">Adicionar tarefas exemplo</button>
        <button id="btnOpenChest" class="toggle">Abrir baú</button>
        <button id="btnEndMonth" class="toggle">Finalizar mês</button>
        <button id="btnExportState" class="toggle">Exportar estado</button>
        <button id="btnToggleTheme" class="toggle">Tema Claro</button>
        <button id="btnToggleGender" class="toggle">Masculino</button>
      </div>
    </header>

    <main>
      <div class="left" aria-label="Avatar e inventário">
        <div class="avatar-box" id="avatarBox">
          <svg viewBox="0 0 240 240" class="avatar-svg" id="avatarSVG" role="img" aria-label="Avatar">
            <rect x="70" y="72" width="100" height="110" rx="14" fill="#b98bff"/>
            <circle cx="120" cy="42" r="30" fill="#fff"/>
          </svg>
        </div>

        <div class="lvl">Nível <strong id="lvl">1</strong> — XP: <strong id="xpText">0</strong>/<strong id="xpNeed">100</strong></div>
        <div class="xpbar" title="Barra de XP"><div id="xpfill" class="xpfill"></div></div>

        <div class="inventory" aria-label="Inventário">
          <div class="small">Inventário (clique para selecionar e clique em outro slot para trocar) — Lixeira no primeiro slot</div>
          <div id="slotContainer" class="slot-row" style="margin-top:8px"></div>
        </div>
      </div>

      <div class="center">
        <section class="tasks-panel" aria-labelledby="tasksTitle">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div class="panel-title" id="tasksTitle">Tarefas</div>
            <div class="small" id="scheduledCount">Agendadas: 0</div>
          </div>

          <div class="parchment" id="parchment">
            <div class="add-row">
              <input id="taskText" type="text" placeholder="Nova tarefa..." />
              <select id="taskType">
                <option value="daily">Diária</option>
                <option value="weekly">Semanal</option>
                <option value="monthly">Mensal</option>
              </select>
              <select id="taskImportance">
                <option value="0">Sem muita importância</option>
                <option value="1">Importante</option>
                <option value="2">Muito importante</option>
                <option value="3">Essencial</option>
              </select>
              <input id="taskDue" type="datetime-local" />
              <button id="btnAddTask" class="btn">Adicionar</button>
            </div>

            <div id="tasksList" aria-live="polite"></div>
          </div>
        </section>
      </div>

      <div class="right">
        <div class="monster-area">
          <h4>Próximo desafio</h4>
          <div id="monsterContainer" style="margin-top:8px" class="small">Nenhum desafio agendado</div>
          <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
            <button id="btnSimulateWin" class="btn">Simular vitória</button>
            <button id="btnOpenChest2" class="btn">Abrir baú (teste)</button>
            <button id="btnEndMonth2" class="btn">Finalizar mês</button>
          </div>
        </div>

        <div style="height:12px"></div>

        <div class="monster-area">
          <h4>Registro</h4>
          <div id="log" class="logs" aria-live="polite"></div>
        </div>
      </div>
    </main>

    <footer>
      Grimório das Tarefas — salvo localmente.
    </footer>
  </div>

  <!-- confirm modal -->
  <div id="confirmModal" class="modal hidden" aria-hidden="true">
    <div class="modal-box">
      <div id="confirmText">Deseja realmente excluir este item?</div>
      <div style="display:flex;gap:8px;margin-top:12px;justify-content:flex-end">
        <button id="confirmYes" class="btn">Sim</button>
        <button id="confirmNo" class="toggle">Não</button>
      </div>
    </div>
  </div>

<script>
/* ============================
   CONFIG & CONSTANTS
   ============================ */
const STORAGE_KEY = 'grimorio_rpg_state_v3';
const BASE_XP = 50;
const TYPE_PENALTY = { daily:0.10, weekly:0.20, monthly:0.30 };
const IMPORTANCE_BONUS_PER_LEVEL = 0.025; // 2.5% per importance level
const IMPORTANCE_FAIL_PENALTY_PER_LEVEL = 0.02;
function xpForLevel(l){ return Math.round(100 * Math.pow(1.25, l-1)); } // scalable, up to 1000

/* ============================
   STATE
   ============================ */
let state = {
  level:1,
  xp:0,
  gender:'male',
  theme:'dark',
  inventory: [], // slot 0 is reserved for trash indicator; items: {id,name,rarity}
  tasks: [], // {id,text,type,importance,created,due,done,expired}
  logs: []
};

/* ============================
   STORAGE
   ============================ */
function loadState(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(raw){ const parsed = JSON.parse(raw); // merge carefully
      state = Object.assign(state, parsed);
      state.inventory = state.inventory || [];
      state.tasks = state.tasks || [];
      state.logs = state.logs || [];
    }
  }catch(e){ console.error('loadState', e); }
}
function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }

/* ============================
   UTILITIES
   ============================ */
function uid(pref='id'){ return pref + '_' + Math.random().toString(36).slice(2,9); }
function nowISO(){ return new Date().toISOString(); }
function fmtDate(iso){ if(!iso) return '--'; const d = new Date(iso); return d.toLocaleString(); }
function minutesBetween(a,b){ return Math.floor((b-a)/60000); }
function daysInMonth(y,m){ return new Date(y,m,0).getDate(); }

/* logging */
function logAdd(txt){
  state.logs.unshift('['+new Date().toLocaleTimeString()+'] '+txt);
  if(state.logs.length>300) state.logs.pop();
  renderLogs();
  saveState();
}

/* ============================
   XP & LEVELS
   ============================ */
function computeTaskXP(task){
  const typePenalty = TYPE_PENALTY[task.type] || 0;
  const importanceIdx = Number(task.importance || 0);
  const importanceBonus = 1 + importanceIdx * IMPORTANCE_BONUS_PER_LEVEL;
  const xp = BASE_XP * (1 - typePenalty) * importanceBonus;
  return Math.round(xp);
}

function addXP(amount){
  if(!amount || amount<=0) return;
  state.xp += Math.round(amount);
  logAdd(`Ganhou ${Math.round(amount)} XP`);
  while(state.level < 1000 && state.xp >= xpForLevel(state.level)){
    state.xp -= xpForLevel(state.level);
    state.level++;
    const title = titleForLevel(state.level);
    logAdd(`Subiu para o nível ${state.level} — ${title}`);
    playEffect('levelup');
  }
  renderStats();
  saveState();
}

function applyExpirationPenalty(task){
  // potential XP
  const potentialXP = computeTaskXP(task);
  const typePenalty = TYPE_PENALTY[task.type] || 0;
  const importanceIdx = Number(task.importance || 0);
  const penaltyPercent = typePenalty + (importanceIdx * IMPORTANCE_FAIL_PENALTY_PER_LEVEL);
  const xpLost = Math.round(potentialXP * penaltyPercent);
  // subtract from current xp and possibly levels
  let remaining = xpLost;
  if(state.xp >= remaining){
    state.xp -= remaining; remaining = 0;
  } else {
    remaining -= state.xp; state.xp = 0;
    while(remaining > 0 && state.level > 1){
      state.level--;
      const need = xpForLevel(state.level);
      if(remaining >= need) remaining -= need;
      else { state.xp = Math.max(0, need - remaining); remaining = 0; }
    }
  }
  logAdd(`Tarefa "${task.text}" expirou: perdeu ${xpLost} XP.`);
  playEffect('fail');
  renderStats();
  saveState();
}

/* Titles by level (sample ranges up to 1000) */
function titleForLevel(l){
  if(l >= 1000) return 'Lenda Eterna';
  if(l >= 500) return 'Arquimago da Constância';
  if(l >= 200) return 'Sábio do Planejamento';
  if(l >= 100) return 'Lorde das Missões';
  if(l >= 50) return 'Mestre da Disciplina';
  if(l >= 20) return 'Vigia dos Dias';
  if(l >= 10) return 'Guardião';
  if(l >= 5) return 'Aventureiro';
  return 'Iniciado das Tarefas';
}

/* ============================
   RENDERERS
   ============================ */
const tasksListEl = document.getElementById('tasksList');
const xpfillEl = document.getElementById('xpfill');
const xpTextEl = document.getElementById('xpText');
const xpNeedEl = document.getElementById('xpNeed');
const lvlEl = document.getElementById('lvl');
const scheduledCountEl = document.getElementById('scheduledCount');
const slotContainer = document.getElementById('slotContainer');
const logEl = document.getElementById('log');
const monsterContainer = document.getElementById('monsterContainer');

function renderStats(){
  xpTextEl.textContent = state.xp;
  xpNeedEl.textContent = xpForLevel(state.level);
  lvlEl.textContent = state.level;
  const pct = Math.min(100, Math.round(100 * (state.xp / xpForLevel(state.level))));
  xpfillEl.style.width = pct + '%';
  scheduledCountEl.textContent = `Agendadas: ${state.tasks.filter(t=>!t.done && !t.expired).length}`;
  // title shown in log top maybe; also update header title if desired
}

function renderLogs(){
  logEl.innerHTML = '';
  state.logs.slice(0,200).forEach(line => { const d = document.createElement('div'); d.textContent = line; logEl.appendChild(d); });
}

/* Inventory rendering - unlimited slots; first slot is trash */
let selectedItem = null; // {index, item}

function renderInventory(){
  slotContainer.innerHTML = '';
  // ensure first slot is trash placeholder UI
  const trashSlot = document.createElement('div'); trashSlot.className = 'slot'; trashSlot.title='Lixeira (clique para excluir item selecionado)';
  trashSlot.innerHTML = '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="6" y="7" width="12" height="12" rx="2" fill="#9b59b6"/><rect x="8" y="4" width="8" height="2" rx="1" fill="#9b59b6"/></svg>';
  trashSlot.addEventListener('click', ()=> {
    if(selectedItem && selectedItem.index !== 0){
      // confirm deletion
      openConfirm(`Deseja realmente excluir "${selectedItem.item.name}"?`, ()=> {
        // delete
        state.inventory.splice(selectedItem.index - 1, 1); // because slot 0 is trash, inventory array starts at slot 1
        selectedItem = null;
        renderInventory();
        saveState();
      });
    }
  });
  slotContainer.appendChild(trashSlot);

  // render actual items: index offset by 1 to account for trash
  state.inventory.forEach((it, i) => {
    const slot = document.createElement('div'); slot.className = 'slot'; slot.dataset.idx = i+1;
    slot.innerHTML = `<div style="text-align:center">${it.name}</div><div class="label">${it.rarity}</div>`;
    slot.addEventListener('click', ()=> {
      handleSlotClick(i+1);
    });
    // highlight if selected
    if(selectedItem && selectedItem.index === i+1){
      slot.style.outline = '2px solid rgba(255,255,255,0.12)';
    }
    slotContainer.appendChild(slot);
  });

  // an empty prompt slot so there's always an empty slot to click to move into
  const emptySlot = document.createElement('div'); emptySlot.className = 'slot empty'; emptySlot.dataset.idx = state.inventory.length + 1;
  emptySlot.title = 'Slot vazio (clique para mover item selecionado para cá)';
  emptySlot.addEventListener('click', ()=> {
    handleSlotClick(state.inventory.length + 1);
  });
  slotContainer.appendChild(emptySlot);
}

/* handle clicking on slots (index with 0=trash, 1..n inventory positions) */
function handleSlotClick(slotIndex){
  // if click on trash is handled elsewhere (trash is index 0)
  if(slotIndex === 0) return;
  // if nothing selected, select this item if present
  if(!selectedItem){
    if(slotIndex <= state.inventory.length){
      selectedItem = { index: slotIndex, item: state.inventory[slotIndex - 1] };
    } else {
      // clicking empty with nothing selected does nothing
      return;
    }
    renderInventory();
    return;
  }
  // if item selected and clicked same slot -> deselect
  if(selectedItem.index === slotIndex){
    selectedItem = null; renderInventory(); return;
  }
  // if clicked a different slot:
  if(slotIndex === 0){ /* handled above; trash click use separate handler */ }
  else if(slotIndex <= state.inventory.length){
    // swap positions
    const srcIdx = selectedItem.index - 1;
    const dstIdx = slotIndex - 1;
    const tmp = state.inventory[dstIdx];
    state.inventory[dstIdx] = state.inventory[srcIdx];
    state.inventory[srcIdx] = tmp;
    selectedItem = null;
    renderInventory(); saveState();
  } else {
    // clicked an empty slot at the end -> move item to end
    const srcIdx = selectedItem.index - 1;
    const moving = state.inventory.splice(srcIdx, 1)[0];
    state.inventory.push(moving);
    selectedItem = null;
    renderInventory(); saveState();
  }
}

/* ============================
   TASKS
   ============================ */
function renderTasks(){
  tasksListEl.innerHTML = '';
  if(state.tasks.length === 0){ tasksListEl.innerHTML = '<div class="small">Nenhuma tarefa.</div>'; renderNextMonster(); renderStats(); return; }
  state.tasks.forEach((task) => {
    if(task.done || task.expired) return;
    const el = document.createElement('div'); el.className = 'task-item';
    const left = document.createElement('div'); left.style.flex='1';
    const title = document.createElement('div'); title.textContent = task.text;
    const meta = document.createElement('div'); meta.className='meta';
    const timeRem = timeRemainingText(task);
    meta.textContent = `${task.type} • ${importanceLabel(task.importance)} • ⏳ ${timeRem}`;
    left.appendChild(title); left.appendChild(meta);

    const actions = document.createElement('div'); actions.className='task-actions';
    const btnConcluir = document.createElement('button'); btnConcluir.textContent='Concluir';
    btnConcluir.onclick = ()=> completeTask(task.id);
    const btnRemove = document.createElement('button'); btnRemove.textContent='Remover'; btnRemove.className='remove';
    btnRemove.onclick = ()=> { if(confirm('Remover tarefa?')){ state.tasks = state.tasks.filter(t=>t.id !== task.id); saveState(); renderTasks(); renderNextMonster(); } };
    actions.appendChild(btnConcluir); actions.appendChild(btnRemove);

    el.appendChild(left); el.appendChild(actions);
    tasksListEl.appendChild(el);
  });
  renderNextMonster();
  renderStats();
}

function importanceLabel(i){ return ['Sem muita importância','Importante','Muito importante','Essencial'][Number(i) || 0]; }

function timeRemainingText(task){
  const now = Date.now();
  const due =
  
