<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Grim√≥rio ‚Äî Visual Refinado (Preview)</title>
<style>
  :root{
    --wood-top:#2b1a10; --wood-bottom:#1a0f07;
    --text-light:#efe9ff; --text-dark:#231b20;
    --muted:#cfc6e8;
    --rar-common:#9e9e9e; --rar-rare:#4aa3ff; --rar-epic:#8a4efd; --rar-legend:#d4af37;
    --lilac-solid: #3b1670; /* fundo s√≥lido das imagens conforme pedido */
    --panel: rgba(255,255,255,0.02);
    --glass: rgba(255,255,255,0.03);
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,var(--wood-top),var(--wood-bottom));color:var(--text-light);-webkit-font-smoothing:antialiased;padding:18px}
  .container{max-width:1280px;margin:0 auto}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
  h1{margin:0;font-size:20px;color:var(--text-light)}
  .hint{color:var(--muted);font-size:13px}
  .controls{display:flex;gap:8px;align-items:center}
  button, .filebtn {cursor:pointer;border-radius:8px;padding:8px 10px;border:none;font-weight:700}
  button{background:var(--text-light);color:#120217}
  .toggle{padding:6px 10px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--text-light)}
  .shelf{margin-top:18px;padding:18px;border-radius:12px;background: linear-gradient(180deg, rgba(0,0,0,0.12), rgba(0,0,0,0.06)); box-shadow: 0 8px 40px rgba(0,0,0,0.6) inset;}
  .sectionTitle{color:#d9c8ff;font-weight:800;margin:8px 0;font-size:16px}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(360px,1fr));gap:14px}
  .card{display:flex;gap:12px;align-items:flex-start;padding:12px;border-radius:10px;background:var(--panel);border:1px solid rgba(255,255,255,0.03)}
  .artWrap{width:140px;height:140px;border-radius:10px;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.04)); box-shadow: 0 6px 16px rgba(0,0,0,0.45) inset}
  .meta{flex:1}
  .name{font-weight:900;font-size:15px}
  .rarity{display:inline-block;margin-top:6px;padding:6px 10px;border-radius:8px;font-weight:900;color:#111;margin-bottom:6px}
  .desc{color:var(--muted);font-style:italic;margin-top:6px}
  .avatarBox{width:160px;height:160px;border-radius:12px;background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.06));display:flex;align-items:center;justify-content:center}
  footer{color:var(--muted);text-align:center;margin-top:18px}
  /* light theme */
  body.light{background: linear-gradient(180deg,#efe6d0,#e6d4a0);color:var(--text-dark)}
  body.light .toggle{color:var(--text-dark)}
  body.light button{background:var(--text-dark);color:var(--text-light)}
  @media(max-width:760px){ .grid{grid-template-columns:1fr} .artWrap{width:120px;height:120px} .avatarBox{width:120px;height:120px} }
  .badge-common{background:var(--rar-common)}
  .badge-rare{background:var(--rar-rare)}
  .badge-epic{background:var(--rar-epic)}
  .badge-legend{background:var(--rar-legend)}
  .mutedSmall{font-size:12px;color:var(--muted)}
  /* subtle hover */
  .card:hover{transform: translateY(-4px); transition: transform 0.18s ease}
  /* accessibility focus */
  .card:focus-within{outline:2px solid rgba(255,255,255,0.06); box-shadow:0 6px 18px rgba(0,0,0,0.5)}
</style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>Grim√≥rio das Artes do RPG de Tarefas</h1>
        <div class="hint">Estante refinada ‚Äî artes 128√ó128 (fundo lil√°s s√≥lido). Clique em um item para equipar no avatar.</div>
      </div>

      <div style="display:flex;align-items:center;gap:10px">
        <div style="display:flex;flex-direction:column;align-items:flex-end;gap:8px">
          <div style="display:flex;gap:8px;align-items:center">
            <div id="avatarBox" class="avatarBox" title="Preview do avatar"></div>
            <div style="display:flex;flex-direction:column;gap:6px;align-items:flex-end">
              <div>
                <button id="btnGender" class="toggle">Masculino</button>
                <button id="btnTheme" class="toggle">Tema Claro</button>
                <button id="btnExport" class="toggle">Exportar ZIP</button>
              </div>
              <div style="display:flex;gap:8px;align-items:center">
                <label class="mutedSmall">M√∫sica:</label>
                <input id="audioFile" class="filebtn" type="file" accept="audio/*" style="padding:6px 10px;border-radius:8px;background:transparent;color:var(--text-light)">
                <button id="btnPlayAudio" class="toggle">‚ñ∂Ô∏è Tocar</button>
                <button id="btnMuteAudio" class="toggle">üîà Mudo</button>
              </div>
            </div>
          </div>
        </div>
      </div>

    </header>

    <main class="shelf" id="shelfRoot" role="main" aria-live="polite">
      <!-- conte√∫do injetado por script -->
    </main>

    <footer>RPG de Tarefas ‚Äî Grim√≥rio das Artes ‚Äî Preview Refinado</footer>
  </div>

<script>
/* ---------------------------
   Config e dados dos assets
   --------------------------- */
const ASSETS = [];
const RARITIES = [
  {k:'common', label:'Comum'},
  {k:'rare', label:'Raro'},
  {k:'epic', label:'√âpica'},
  {k:'legend', label:'Lend√°ria'}
];

function addWeapon(name){ RARITIES.forEach(r=> ASSETS.push({category:'Armas', type:'weapon', key:name.toLowerCase(), name:`${name} ‚Äî ${r.label}`, rarity:r.k, rarityLabel:r.label})); }
function addArmor(k,n){ RARITIES.forEach(r=> ASSETS.push({category:'Armaduras', type:'armor', key:k, name:`${n} ‚Äî ${r.label}`, rarity:r.k, rarityLabel:r.label})); }
function addCosmetic(k,n){ RARITIES.forEach(r=> ASSETS.push({category:'Cosm√©ticos', type:'cosmetic', key:k, name:`${n} ‚Äî ${r.label}`, rarity:r.k, rarityLabel:r.label})); }
function addChests(){ const names=['Ba√∫ ‚Äî Comum','Ba√∫ ‚Äî Raro','Ba√∫ ‚Äî √âpico','Ba√∫ ‚Äî Lend√°rio']; RARITIES.forEach((r,i)=> ASSETS.push({category:'Ba√∫s', type:'chest', key:'chest', name:names[i], rarity:r.k, rarityLabel:r.label})); }
function addMonsters(){
  const missions=['Di√°ria','Semanal','Mensal'];
  for(const m of missions){
    for(let imp=1; imp<=4; imp++){
      const labelImp = imp===1?'Sem muita import√¢ncia':imp===2?'Importante':imp===3?'Muito importante':'Essencial';
      const rarity = imp===1?'common':imp===2?'rare':imp===3?'epic':'legend';
      ASSETS.push({category:'Monstros', type:'monster', key:m.toLowerCase(), name:`${m} ‚Äî ${labelImp}`, rarity:rarity, rarityLabel:labelImp, importance:imp});
    }
  }
}

/* preencher arrays */
['Espada','Cajado','Machado','Arco','Foice','Lan√ßa'].forEach(addWeapon);
[
  {k:'tunica', n:'T√∫nica do Aventureiro'},
  {k:'guardiao', n:'Armadura do Guardi√£o'},
  {k:'cacador', n:'Armadura do Ca√ßador'},
  {k:'feiticeiro', n:'Armadura do Feiticeiro'},
  {k:'couraca', n:'Coura√ßa Estelar'}
].forEach(a=> addArmor(a.k,a.n));

addCosmetic('capa','Capa (Curta)'); addCosmetic('capa_long','Capa (Longa)');
addCosmetic('chap_advent','Chap√©u (Aventureiro)'); addCosmetic('chap_mage','Chap√©u (Mago)');
addChests(); addMonsters();
/* itens iniciais no come√ßo */
ASSETS.unshift({category:'Equipamento Inicial', type:'initial', key:'graveto', name:'Graveto Inicial ‚Äî Comum', rarity:'common', rarityLabel:'Comum'});
ASSETS.unshift({category:'Equipamento Inicial', type:'initial', key:'pijama', name:'Pijama do Her√≥i ‚Äî Comum', rarity:'common', rarityLabel:'Comum'});

/* ---------------------------
   Utilit√°rios SVG & gera√ß√£o
   --------------------------- */

/* cor de raridade */
function rarityColor(k){
  if(k==='common') return '#9e9e9e';
  if(k==='rare') return '#4aa3ff';
  if(k==='epic') return '#8a4efd';
  if(k==='legend') return '#d4af37';
  return '#9e9e9e';
}

/* cria string SVG 128x128 com fundo lil√°s s√≥lido e elementos de acordo com tipo/key.
   As SVGs s√£o inline (n√£o dependem de imagens externas) ‚Äî evita o problema de "n√£o aparecer".
*/
function createAssetSVGString(asset, gender='male'){
  const bg = getComputedStyle(document.documentElement).getPropertyValue('--lilac-solid') || '#3b1670';
  const col = rarityColor(asset.rarity);
  const glyph = asset.type === 'weapon' ? '‚öî' : asset.type==='armor' ? '‚õ®' : asset.type==='cosmetic' ? '‚òÖ' : asset.type==='chest' ? '‚ò∑' : asset.type==='monster' ? '‚úπ' : '‚ú¶';

  // shape por tipo/chave (melhor detalhamento das formas)
  let shape = '';
  if(asset.type === 'weapon'){
    const k = asset.key;
    if(k === 'espada'){
      shape = `<g transform="translate(0,0)">
        <rect x="58" y="20" width="12" height="72" rx="3" fill="#2b1b23"/>
        <polygon points="64,8 82,42 64,54 46,42" fill="${col}" stroke="#1a0e13" stroke-width="1.4"/>
        </g>`;
    } else if(k === 'cajado'){
      shape = `<g><rect x="62" y="16" width="8" height="96" rx="4" fill="${col}" /><circle cx="66" cy="12" r="12" fill="${col}" opacity="0.16"/></g>`;
    } else if(k === 'machado'){
      shape = `<g><rect x="58" y="24" width="18" height="12" rx="2" fill="${col}" /><rect x="62" y="8" width="8" height="72" rx="3" fill="#2b1b23"/></g>`;
    } else if(k === 'arco'){
      shape = `<g><path d="M40 28 q24 -18 44 0 q-6 8 -44 0 z" fill="none" stroke="${col}" stroke-width="4" stroke-linecap="round"/></g>`;
    } else if(k === 'foice'){
      shape = `<g><path d="M44 22 q30 6 26 38 q-18 -6 -26 -10 z" fill="${col}" /></g>`;
    } else if(k === 'lan√ßa'){
      shape = `<g><rect x="62" y="8" width="6" height="100" fill="${col}" /><polygon points="64,2 76,18 52,18" fill="${col}" /></g>`;
    } else shape = `<rect x="44" y="28" width="40" height="44" rx="6" fill="${col}" />`;
  } else if(asset.type === 'armor'){
    shape = `<g><rect x="30" y="28" width="68" height="76" rx="12" fill="${col}" stroke="#24161e" stroke-width="1.6"/><path d="M40 48 L88 48" stroke="#24161e" stroke-width="1"/></g>`;
  } else if(asset.type === 'cosmetic'){
    if(asset.key.includes('capa')) shape = `<g><path d="M36 28 q40 18 76 0 v80 h-76 z" fill="${col}" /></g>`;
    else shape = `<g><ellipse cx="64" cy="36" rx="32" ry="14" fill="${col}" /></g>`;
  } else if(asset.type === 'chest'){
    shape = `<g><rect x="28" y="46" width="72" height="52" rx="8" fill="#4b362b" stroke="#2b1a18"/><rect x="24" y="34" width="80" height="22" rx="8" fill="${col}" stroke="#2b1a18"/></g>`;
  } else if(asset.type === 'monster'){
    shape = `<g><ellipse cx="64" cy="70" rx="36" ry="28" fill="${col}" opacity="0.96"/><circle cx="64" cy="58" r="6" fill="#120712"/></g>`;
  } else if(asset.type === 'initial'){
    if(asset.key === 'pijama') shape = `<g><rect x="34" y="34" width="60" height="72" rx="10" fill="#b98bff"/><circle cx="64" cy="22" r="14" fill="#efe6ff"/></g>`;
    else shape = `<g><rect x="60" y="12" width="8" height="104" rx="4" fill="#8b5a3a"/></g>`;
  } else shape = `<rect x="36" y="36" width="56" height="56" rx="8" fill="${col}" />`;

  // anima√ß√£o leve para raridade > common
  let anim = '';
  if(asset.rarity !== 'common'){
    const alpha = asset.rarity === 'rare' ? 0.06 : asset.rarity === 'epic' ? 0.08 : 0.12;
    const dur = asset.rarity === 'rare' ? '2.6s' : asset.rarity === 'epic' ? '3.2s' : '3.6s';
    anim = `<g><circle cx="64" cy="64" r="${asset.rarity==='rare'?28:asset.rarity==='epic'?30:34}" fill="${col}" opacity="${alpha}">
      <animate attributeName="opacity" values="0.02;${alpha*1.8};0.02" dur="${dur}" repeatCount="indefinite" /></circle>
    </g>`;
  }

  const svg = `<?xml version="1.0" encoding="utf-8"?>
  <svg xmlns="http://www.w3.org/2000/svg" width="128" height="128" viewBox="0 0 128 128" role="img" aria-label="${escapeHtml(asset.name)}">
    <rect width="128" height="128" fill="${bg}" />
    ${anim}
    <g transform="translate(0,0)">
      ${shape}
    </g>
    <rect x="6" y="6" width="58" height="18" rx="6" fill="rgba(0,0,0,0.14)"/>
    <text x="35" y="18" font-size="10" text-anchor="middle" fill="#fff" font-family="sans-serif">${escapeHtml(asset.rarityLabel)}</text>
  </svg>`;
  return svg;
}

function escapeHtml(s){ return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

/* converter string SVG -> elemento DOM (inline) */
function svgStringToElement(svgString){
  const wrapper = document.createElement('div');
  wrapper.innerHTML = svgString;
  return wrapper.firstElementChild;
}

/* converter SVG string -> PNG blob (usado para exportar) */
function svgStringToPng(svgString, filename){
  return new Promise((res, rej) => {
    const img = new Image();
    const blob = new Blob([svgString], {type:'image/svg+xml;charset=utf-8'});
    const url = URL.createObjectURL(blob);
    img.onload = () => {
      try{
        const canvas = document.createElement('canvas');
        canvas.width = 128;
        canvas.height = 128;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0);
        canvas.toBlob(b => {
          URL.revokeObjectURL(url);
          res({name:filename, blob:b, dataUrl:canvas.toDataURL('image/png')});
        }, 'image/png');
      }catch(e){ URL.revokeObjectURL(url); rej(e); }
    };
    img.onerror = (e) => { URL.revokeObjectURL(url); rej(new Error('Falha ao renderizar SVG')); };
    img.src = url;
  });
}

/* ---------------------------
   UI: render shelf & avatar
   --------------------------- */
const shelfRoot = document.getElementById('shelfRoot');
const avatarBox = document.getElementById('avatarBox');
let currentGender = 'male';
let lightMode = false;
let equipped = null;

function generateDescription(a){
  const base = a.type === 'weapon' ? 'Uma arma que sussurra antigas can√ß√µes de batalha.' :
               a.type === 'armor' ? 'Prote√ß√£o forjada para travessias perigosas.' :
               a.type === 'cosmetic' ? 'Um acess√≥rio de presen√ßa e estilo.' :
               a.type === 'chest' ? 'Um ba√∫ que guarda surpresas e destino.' :
               a.type === 'monster' ? 'Um inimigo que testa coragem e h√°bito.' :
               'Um artefato do Grim√≥rio.';
  let extra = '';
  if(a.rarity==='rare') extra = ' Uma luz tenue adorna sua superf√≠cie.';
  if(a.rarity==='epic') extra = ' Runas suaves cintilam quando observado.';
  if(a.rarity==='legend') extra = ' Uma aura eterna pulsa como estrela aprisionada.';
  return base + extra;
}

function createCard(asset){
  const el = document.createElement('div'); el.className='card'; el.tabIndex = 0;
  const artWrap = document.createElement('div'); artWrap.className='artWrap';
  const meta = document.createElement('div'); meta.className='meta';
  const name = document.createElement('div'); name.className='name'; name.textContent = asset.name;
  const badge = document.createElement('div'); badge.className='rarity'; badge.textContent = asset.rarityLabel;
  badge.style.background = rarityColor(asset.rarity);
  const desc = document.createElement('div'); desc.className='desc'; desc.textContent = generateDescription(asset);

  // create inline svg
  const svgStr = createAssetSVGString(asset, currentGender);
  const svgEl = svgStringToElement(svgStr);
  svgEl.classList.add('asset');
  // ensure focusable for a11y
  svgEl.setAttribute('role','img'); svgEl.setAttribute('aria-label', asset.name);

  artWrap.appendChild(svgEl);
  meta.appendChild(name); meta.appendChild(badge); meta.appendChild(desc);
  el.appendChild(artWrap); el.appendChild(meta);

  // click equips preview in avatar
  el.addEventListener('click', ()=> {
    equipped = asset;
    renderAvatar();
    // feedback
    el.style.outline = '2px solid rgba(255,255,255,0.06)';
    setTimeout(()=> el.style.outline = '', 700);
  });

  return el;
}

function buildShelf(){
  shelfRoot.innerHTML = '';
  const order = ['Equipamento Inicial','Armas','Armaduras','Cosm√©ticos','Ba√∫s','Monstros'];
  order.forEach(cat=>{
    const title = document.createElement('div'); title.className='sectionTitle'; title.textContent = cat;
    shelfRoot.appendChild(title);
    const grid = document.createElement('div'); grid.className='grid';
    const items = ASSETS.filter(a=> a.category === cat);
    items.forEach(it => grid.appendChild(createCard(it)));
    shelfRoot.appendChild(grid);
  });
}

function renderAvatar(){
  avatarBox.innerHTML = '';
  // create SVG preview larger (scaled)
  const svgStr = createAvatarPreviewSVGString(currentGender, equipped);
  const el = svgStringToElement(svgStr);
  avatarBox.appendChild(el);
}

function createAvatarPreviewSVGString(gender, asset){
  const bgRect = ''; // transparent bg in box so it shows estante
  let overlay = '';
  if(asset){
    if(asset.type === 'weapon') overlay = `<rect x="170" y="40" width="12" height="120" rx="6" fill="${rarityColor(asset.rarity)}"/>`;
    else if(asset.type === 'armor') overlay = `<rect x="80" y="92" width="80" height="80" rx="10" fill="${rarityColor(asset.rarity)}"/>`;
    else if(asset.type === 'cosmetic') overlay = `<path d="M60 80 q60 -30 120 0 v60 h-120 z" fill="${rarityColor(asset.rarity)}"/>`;
    else if(asset.type === 'chest') overlay = `<rect x="86" y="120" width="68" height="38" rx="6" fill="${rarityColor(asset.rarity)}"/>`;
    else if(asset.type === 'monster') overlay = `<ellipse cx="120" cy="120" rx="44" ry="36" fill="${rarityColor(asset.rarity)}"/>`;
    else if(asset.type === 'initial'){ if(asset.key==='pijama') overlay = `<rect x="80" y="92" width="80" height="80" rx="10" fill="#b98bff"/>`; else overlay = `<rect x="170" y="20" width="12" height="160" rx="6" fill="#8b5a3a"/>`; }
  }
  const svg = `<?xml version="1.0" encoding="utf-8"?>
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 240 240" width="140" height="140">
    <rect x="0" y="0" width="240" height="240" rx="12" fill="none"/>
    <rect x="70" y="72" width="100" height="110" rx="14" fill="#c9a6ff"/>
    <circle cx="120" cy="42" r="26" fill="#efe6ff"/>
    ${overlay}
  </svg>`;
  return svg;
}

/* ---------------------------
   Eventos UI & toggles
   --------------------------- */
document.getElementById('btnGender').addEventListener('click', ()=>{
  currentGender = (currentGender==='male') ? 'female' : 'male';
  document.getElementById('btnGender').textContent = (currentGender==='male') ? 'Masculino' : 'Feminino';
  // re-render (gender could affect sprites if we add variants)
  buildShelf();
  renderAvatar();
});

document.getElementById('btnTheme').addEventListener('click', ()=>{
  lightMode = !lightMode;
  document.body.classList.toggle('light', lightMode);
  document.getElementById('btnTheme').textContent = lightMode ? 'Tema Escuro' : 'Tema Claro';
  buildShelf(); renderAvatar();
});

/* ---------------------------
   √Åudio: carregar e reproduzir
   - o usu√°rio carrega o arquivo (MP3/OGG) local via input
   - bot√£o play/pause e mute
   --------------------------- */
let audio = null;
let audioLoaded = false;
const audioInput = document.getElementById('audioFile');
const btnPlayAudio = document.getElementById('btnPlayAudio');
const btnMuteAudio = document.getElementById('btnMuteAudio');

audioInput.addEventListener('change', (e)=>{
  const f = e.target.files && e.target.files[0];
  if(!f) return;
  if(audio){ audio.pause(); audio = null; audioLoaded = false; }
  audio = new Audio(URL.createObjectURL(f));
  audio.loop = true; audio.volume = 0.55;
  audioLoaded = true;
  btnPlayAudio.textContent = '‚ñ∂Ô∏è Tocar';
  alert('√Åudio carregado ‚Äî use o bot√£o Tocar para iniciar (navegadores requerem intera√ß√£o do usu√°rio).');
});

btnPlayAudio.addEventListener('click', ()=>{
  if(!audioLoaded){ alert('Carregue um arquivo de √°udio (MP3/OGG) usando o bot√£o "Carregar m√∫sica".'); return; }
  if(audio.paused){ audio.play(); btnPlayAudio.textContent = '‚è∏ Pausar'; }
  else { audio.pause(); btnPlayAudio.textContent = '‚ñ∂Ô∏è Tocar'; }
});
btnMuteAudio.addEventListener('click', ()=>{
  if(!audio) return;
  audio.muted = !audio.muted;
  btnMuteAudio.textContent = audio.muted ? 'üîá Mudo' : 'üîà Mudo';
});

/* ---------------------------
   Export: gera PNGs via SVG -> canvas e zip (JSZip injetado se necess√°rio)
   --------------------------- */
async functi
