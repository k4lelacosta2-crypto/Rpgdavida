<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>PokéTarefas — Capture & Evolua</title>
<style>
  :root{
    --bg1:#d9c6ff; --bg2:#a68bff; --accent:#d62828; --purple:#6b00ff;
  }
  html,body{height:100%;margin:0;font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;}
  body{
    background: linear-gradient(180deg,var(--bg1),var(--bg2));
    display:flex;align-items:flex-start;justify-content:center;padding:28px;color:#222;
  }
  .wrap{width:980px;max-width:98%;background:linear-gradient(180deg,#fffefcff, #fff9ffcc);border-radius:12px;padding:18px;border:4px solid #f3e8ff;box-shadow:0 14px 40px rgba(18,7,38,0.25);}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px}
  h1{margin:0;color:#3d2e7a;font-size:1.9rem;letter-spacing:0.6px}
  .status{ text-align:right; font-size:0.95rem; color:#2b0650 }
  .xp-bar-wrap{background:#efe8ff;border-radius:999px;padding:4px;margin-top:8px;border:2px solid #e0c7ff}
  .xp-bar{height:18px;border-radius:999px;background:linear-gradient(90deg,#d6bbff,#8b5cf6);width:0%;transition:width .45s ease}
  main{display:grid;grid-template-columns:1fr 360px;gap:16px;margin-top:16px}
  .tasks{background:#fff;border-radius:10px;padding:14px;border:2px solid #efe0ff;min-height:220px}
  .tasks .controls{display:flex;gap:8px;margin-bottom:10px}
  input[type=text]{flex:1;padding:10px;border-radius:8px;border:2px solid #e9ddff;outline:none;font-size:0.95rem}
  button{background:linear-gradient(180deg,#8b5cf6,#6d28d9);border:none;color:white;padding:9px 12px;border-radius:8px;cursor:pointer}
  .task{display:flex;justify-content:space-between;padding:10px;border-radius:8px;background:linear-gradient(180deg,#fff,#fbf7ff);margin-bottom:8px;align-items:center;border:1px solid #efe6ff}
  .task .meta{font-size:0.95rem}
  .pokedex{background:#fff;border-radius:10px;padding:12px;border:2px solid #ffdede;min-height:220px}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(90px,1fr));gap:8px}
  .card{background:linear-gradient(180deg,#fff,#fff9);border-radius:8px;padding:8px;text-align:center;border:2px solid #ffdede;min-height:88px;display:flex;flex-direction:column;align-items:center;justify-content:center}
  .card img{width:64px;height:64px;image-rendering:pixelated}
  .controls-row{display:flex;gap:8px;margin-top:10px}
  .muted{font-size:0.85rem;color:#4b3a6a}
  /* overlays & animations */
  .overlay{position:fixed;left:0;top:0;right:0;bottom:0;display:flex;align-items:center;justify-content:center;pointer-events:none}
  .lvl-up{pointer-events:auto;background:radial-gradient(circle at center, rgba(255,255,255,0.85), rgba(255,255,255,0.2));backdrop-filter:blur(6px);padding:24px;border-radius:12px;border:4px solid #f3e8ff;box-shadow:0 20px 50px rgba(99,41,200,0.25);transform:scale(0.7);opacity:0;transition:all .45s cubic-bezier(.2,.9,.2,1)}
  .lvl-up.show{transform:scale(1);opacity:1}
  .lvl-title{font-weight:800;color:#4b2b7f;font-size:1.6rem;margin-bottom:6px}
  .sparkles{position:absolute;pointer-events:none;inset:0;overflow:hidden}
  .spark{position:absolute;width:8px;height:8px;background:linear-gradient(90deg,#fffacd,#ffd6f2);border-radius:50%;filter:blur(.6px);opacity:0.95;animation:rise 1.6s linear infinite}
  @keyframes rise{0%{transform:translateY(20px) scale(.6);opacity:0}30%{opacity:1}100%{transform:translateY(-220px) scale(1.1);opacity:0}}
  /* evolution animation */
  .evo-stage{display:flex;align-items:center;gap:18px}
  .evo-sprite{width:96px;height:96px;image-rendering:pixelated;transition:all .8s cubic-bezier(.2,.9,.2,1)}
  .evo-sprite.grow{transform:scale(1.3) rotate(-6deg)}
  .evo-flash{position:absolute;inset:0;background:radial-gradient(circle at center, rgba(255,255,255,0.85), rgba(255,255,255,0));opacity:0;transition:opacity .25s}
  .evo-flash.show{opacity:1}
  /* small helpers */
  .small{font-size:0.85rem}
</style>
</head>
<body>
<div class="wrap" id="app">
  <header>
    <div>
      <h1>PokéTarefas</h1>
      <div class="muted">Capture criaturas ao subir de nível — estética Pokémon</div>
    </div>
    <div class="status">
      <div>Nível <strong id="level">1</strong></div>
      <div class="small">XP: <span id="xp">0</span> / <span id="next">100</span></div>
      <div class="xp-bar-wrap"><div id="xp-bar" class="xp-bar"></div></div>
    </div>
  </header>

  <main>
    <section class="tasks">
      <div class="controls">
        <input id="task-input" placeholder="Nova tarefa..." />
        <button id="add-btn">Adicionar</button>
      </div>
      <div id="task-list" aria-live="polite"></div>
      <div class="controls-row">
        <button id="debug-xp">+50 XP (teste)</button>
        <button id="export">Exportar HTML</button>
        <div class="muted" style="margin-left:auto">Pool tenta usar PokéAPI (só reais)</div>
      </div>
    </section>

    <aside class="pokedex">
      <div style="display:flex;align-items:center;justify-content:space-between">
        <strong>Pokédex Obtida</strong>
        <div class="small" id="pool-count">Pool: 0</div>
      </div>
      <div class="grid" id="pokedex"></div>
    </aside>
  </main>
</div>

<!-- Overlays -->
<div class="overlay" id="overlay" aria-hidden="true" style="display:none">
  <div class="lvl-up" id="lvlup">
    <div class="sparkles" id="sparkles"></div>
    <div style="position:relative">
      <div class="lvl-title" id="lvlup-title">Você subiu para o Nível X!</div>
      <div id="lvlup-body" class="small">Recebeu um novo Pokémon</div>
      <div id="evo-area" style="margin-top:12px"></div>
    </div>
    <div style="margin-top:12px;text-align:right">
      <button id="close-lvl">Fechar</button>
    </div>
  </div>
  <div class="evo-flash" id="evo-flash"></div>
</div>

<script>
/* State */
let level = 1, xp = 0, nextXp = calcNext(level);
let tasks = [];
let pool = []; // {name, url}
let pokedex = []; // {name, sprite, id}
const POOL_LIMIT = 1100;

/* Utils */
function calcNext(l){ return Math.floor(100 * Math.pow(1.18, l-1) + l*10); }
function $(id){ return document.getElementById(id); }
function save(){ localStorage.setItem('pt_tasks', JSON.stringify(tasks)); localStorage.setItem('pt_state', JSON.stringify({level,xp,pokedex})); }
function load(){ const t=localStorage.getItem('pt_tasks'); if(t) tasks=JSON.parse(t); const s=localStorage.getItem('pt_state'); if(s){ const o=JSON.parse(s); level=o.level||1; xp=o.xp||0; pokedex=o.pokedex||[];} }

/* WebAudio capture sound (synth) */
let audioCtx;
function playCaptureSound(){
  try{
    if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const t0 = audioCtx.currentTime;
    // a short rising arpeggio + blip
    const freqs = [880, 1047, 1319];
    freqs.forEach((f,i)=>{
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.type = 'sine';
      o.frequency.value = f;
      g.gain.value = 0;
      o.connect(g); g.connect(audioCtx.destination);
      o.start(t0 + i*0.04);
      g.gain.linearRampToValueAtTime(0.12, t0 + i*0.04 + 0.02);
      g.gain.linearRampToValueAtTime(0.0, t0 + i*0.04 + 0.22);
      o.stop(t0 + i*0.04 + 0.24);
    });
    // final blip
    const o2 = audioCtx.createOscillator();
    const g2 = audioCtx.createGain();
    o2.type='triangle'; o2.frequency.value=400;
    g2.gain.value=0.08;
    o2.connect(g2); g2.connect(audioCtx.destination);
    o2.start(t0+0.16); g2.gain.exponentialRampToValueAtTime(0.001, t0+0.42);
    o2.stop(t0+0.46);
  }catch(e){ console.warn('Audio failed', e); }
}

/* UI */
function updateUI(){
  $('level').innerText = level;
  $('xp').innerText = xp;
  $('next').innerText = nextXp;
  const pct = Math.min(100, Math.round((xp/nextXp)*100));
  $('xp-bar').style.width = pct + '%';
  renderTasks();
  renderDex();
  $('pool-count').innerText = 'Pool: ' + (pool.length || 0);
  save();
}

/* Tasks */
function addTask(){
  const v = $('task-input').value.trim();
  if(!v) return;
  tasks.push({id:Date.now(),title:v, xp:20, done:false});
  $('task-input').value = '';
  updateUI();
}
function renderTasks(){
  const el = $('task-list'); el.innerHTML='';
  tasks.forEach((t,i)=>{
    const div = document.createElement('div'); div.className='task';
    const meta = document.createElement('div'); meta.className='meta'; meta.innerText = t.title + '  ';
    const btn = document.createElement('button'); btn.innerText='Completar';
    btn.onclick = ()=>completeTask(i);
    div.appendChild(meta); div.appendChild(btn); el.appendChild(div);
  });
}
async function completeTask(index){
  const t = tasks[index];
  tasks.splice(index,1);
  // grant xp
  await grantXp(t.xp);
  updateUI();
}

/* Fetch pool from PokéAPI, fallback to placeholders if fails */
async function loadPool(){
  try{
    const res = await fetch('https://pokeapi.co/api/v2/pokemon?limit=20000');
    if(!res.ok) throw new Error('pokeapi fail');
    const json = await res.json();
    // keep only real species (api contains all): limit to first ~1025 species
    pool = json.results.slice(0, 1100).map(r=>({name: r.name, url: r.url}));
    if(pool.length < POOL_LIMIT){
      // fill placeholders
      for(let i=pool.length;i<POOL_LIMIT;i++) pool.push({name:`Bestiario-${i+1}`, url:null});
    }
  }catch(e){
    // fallback placeholders
    pool = Array.from({length:POOL_LIMIT}).map((_,i)=>({name:`Bestiario-${i+1}`, url:null}));
    console.warn('Falha ao carregar PokéAPI, usando placeholders');
  } finally { updateUI(); }
}

/* Grant XP and handle level ups + granted pokémon */
async function grantXp(amount){
  xp += amount;
  // handle multi-level gains
  let leveled = false;
  while(xp >= nextXp){
    xp -= nextXp;
    level++;
    nextXp = calcNext(level);
    leveled = true;
    // on level up, grant a random unseen pokemon
    await grantRandomPokemon();
  }
  updateUI();
  if(leveled) {
    // show level-up overlay
    showLevelUpOverlay();
  }
}

/* Choose random unseen pokemon from pool */
async function grantRandomPokemon(){
  if(!pool || pool.length===0) return;
  const available = pool.filter(p => !pokedex.some(k=>k.name===p.name));
  if(available.length===0) return;
  const chosen = available[Math.floor(Math.random()*available.length)];
  // fetch sprite if available
  let sprite=null, id=null;
  if(chosen.url){
    try{
      // extract id from url
      const parts = chosen.url.split('/').filter(Boolean);
      id = parts[parts.length-1];
      const r = await fetch(`https://pokeapi.co/api/v2/pokemon/${id}`);
      if(r.ok){
        const pj = await r.json();
        sprite = pj.sprites.front_default || pj.sprites.other?.['official-artwork']?.front_default || null;
      }
    }catch(e){ console.warn('sprite fail', e); }
  }
  // play capture sound effect
  playCaptureSound();
  // determine evolution relationship with last caught
  let triggeredEvo=false;
  if(pokedex.length>0 && chosen.url){
    try{
      const last = pokedex[pokedex.length-1];
      const speciesRes = await fetch(`https://pokeapi.co/api/v2/pokemon-species/${id}`);
      if(speciesRes.ok){
        const speciesJson = await speciesRes.json();
        const chainURL = speciesJson.evolution_chain?.url;
        if(chainURL){
          const chainRes = await fetch(chainURL);
          if(chainRes.ok){
            const chainJson = await chainRes.json();
            // collect species names in evolution chain in order
            const names = [];
            function walk(node){
              if(!node) return;
              names.push(node.species.name);
              if(node.evolves_to && node.evolves_to.length) {
                node.evolves_to.forEach(n=>walk(n));
              }
            }
            walk(chainJson.chain);
            // if last.name present and appears before chosen.name, consider it an evolution
            const lastName = last.name;
            const chosenName = chosen.name;
            const idxLast = names.indexOf(lastName);
            const idxChosen = names.indexOf(chosenName);
            if(idxLast!==-1 && idxChosen!==-1 && idxLast < idxChosen){
              // evolution detected: animate evolution (last -> chosen)
              await showEvolutionAnimation(last.sprite, sprite, last.name, chosenName);
              triggeredEvo = true;
            }
          }
        }
      }
    }catch(e){ console.warn('evo detect fail', e); }
  }
  // if evolution not triggered, show normal capture animation in level up overlay
  pokedex.push({name: chosen.name, sprite: sprite, id: id});
  updateUI();
  if(!triggeredEvo){
    // show overlay with captured pokemon
    showLevelUpOverlay(chosen.name, sprite);
  }
}

/* Render dex */
function renderDex(){
  const el = $('pokedex'); el.innerHTML = '';
  pokedex.forEach(p=>{
    const c = document.createElement('div'); c.className='card';
    const img = document.createElement('img'); img.src = p.sprite || placeholderSprite(p.name);
    img.alt = p.name;
    const nm = document.createElement('div'); nm.innerText = capitalize(p.name);
    c.appendChild(img); c.appendChild(nm); el.appendChild(c);
  });
}

/* Placeholder sprite as SVG data URI with initials */
function placeholderSprite(name){
  const initials = name.split('-').map(s=>s[0]).join('').toUpperCase().slice(0,3);
  const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='96' height='96'><rect width='100%' height='100%' fill='#f3e8ff'/><text x='50%' y='50%' dy='0.35em' font-size='26' text-anchor='middle' fill='#6d28d9' font-family='Verdana'>${initials}</text></svg>`;
  return 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
}
function capitalize(s){ if(!s) return ''; return s.charAt(0).toUpperCase()+s.slice(1); }

/* Overlays: level up and evolution */
function showLevelUpOverlay(capturedName, sprite){
  const overlay = $('overlay'); const box = $('lvlup'); const spark = $('sparkles');
  overlay.style.display = 'flex'; overlay.setAttribute('aria-hidden','false');
  box.classList.add('show');
  $('lvlup-title').innerText = `Você subiu para o Nível ${level}!`;
  $('lvlup-body').innerText = capturedName ? `Você capturou: ${capitalize(capturedName)}` : 'Você subiu de nível!';
  // clear sparkles
  spark.innerHTML = '';
  // create some sparkle particles
  for(let i=0;i<12;i++){
    const s = document.createElement('span'); s.className='spark';
    s.style.left = (10 + Math.random()*80) + '%';
    s.style.top = (40 + Math.random()*30) + '%';
    s.style.animationDelay = (Math.random()*0.8) + 's';
    s.style.width = (6 + Math.random()*10) + 'px';
    s.style.height = s.style.width;
    spark.appendChild(s);
  }
  const evoArea = $('evo-area'); evoArea.innerHTML = '';
  if(capturedName){
    const d = document.createElement('div'); d.style.display='flex'; d.style.alignItems='center'; d.style.gap='12px';
    const img = document.createElement('img'); img.src = sprite || placeholderSprite(capturedName); img.style.width='96px'; img.style.height='96px';
    const nm = document.createElement('div'); nm.innerHTML = `<strong>${capitalize(capturedName)}</strong><div class="small">Novo no seu bestiário</div>`;
    d.appendChild(img); d.appendChild(nm); evoArea.appendChild(d);
  }
  // close button handler
  $('close-lvl').onclick = ()=>{ box.classList.remove('show'); overlay.style.display='none'; overlay.setAttribute('aria-hidden','true'); }
}

/* Evolution animation: show last sprite morphing to new sprite */
function showEvolutionAnimation(oldSprite, newSprite, oldName, newName){
  return new Promise(resolve=>{
    const overlay = $('overlay'); const box = $('lvlup'); const flash = $('evo-flash');
    overlay.style.display='flex'; overlay.setAttribute('aria-hidden','false');
    box.classList.add('show');
    $('lvlup-title').innerText = `Evolução!`;
    $('lvlup-body').innerText = `${capitalize(oldName)} evoluiu para ${capitalize(newName)}!`;
    const evoArea = $('evo-area'); evoArea.innerHTML = '';
    const container = document.createElement('div'); container.className='evo-stage';
    const imgOld = document.createElement('img'); imgOld.className='evo-sprite'; imgOld.src = oldSprite || placeholderSprite(oldName);
    const arrow = document.createElement('div'); arrow.innerHTML = '&#10132;'; arrow.style.fontSize='28px';
    const imgNew = document.createElement('img'); imgNew.className='evo-sprite'; imgNew.src = newSprite || placeholderSprite(newName);
    container.appendChild(imgOld); container.appendChild(arrow); container.appendChild(imgNew);
    evoArea.appendChild(container);
    // animate: grow old, flash, then replace with grown new
    setTimeout(()=>{ imgOld.classList.add('grow'); }, 80);
    setTimeout(()=>{ flash.classList.add('show'); playCaptureSound(); }, 700);
    setTimeout(()=>{ imgOld.classList.remove('grow'); imgNew.classList.add('grow'); flash.classList.remove('show'); }, 1050);
    // finish after animation
    setTimeout(()=>{ $('close-lvl').onclick = ()=>{ box.classList.remove('show'); overlay.style.display='none'; overlay.setAttribute('aria-hidden','true'); resolve(); }; }, 1400);
  });
}

/* Export HTML button: create a minimal snapshot of current state */
function exportHTML(){
  const snapshot = `<!doctype html><html><head><meta charset="utf-8"><title>PokéTarefas Export</title></head><body><h1>Snapshot</h1><p>Level: ${level} XP: ${xp}/${nextXp}</p></body></html>`;
  const blob = new Blob([snapshot], {type:'text/html'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'poketarefas_snapshot.html'; a.click(); URL.revokeObjectURL(url);
}

/* UI Events */
$('add-btn').onclick = addTask;
$('task-input').addEventListener('keydown', e=>{ if(e.key==='Enter') addTask(); });
$('debug-xp').onclick = ()=>grantXp(50);
$('export').onclick = exportHTML;

/* Init */
load();
updateUI();
loadPool();
</script>
</body>
</html>
